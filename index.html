<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KartTiming Pro - Firebase Realtime</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-dark: #121212; --bg-panel: #1e1e1e; --primary: #00e676;
            --secondary: #2979ff; --danger: #ff1744; --warning: #ffea00;
            --text-main: #ffffff; --text-muted: #b0b0b0;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Exo 2', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 80px; background-color: #000; display: flex; flex-direction: column; align-items: center; padding-top: 20px; border-right: 1px solid #333; transition: width 0.3s; z-index: 10; flex-shrink: 0; }
        .sidebar:hover { width: 200px; }
        .nav-btn { background: none; border: none; color: var(--text-muted); width: 100%; padding: 15px; text-align: left; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; gap: 15px; transition: 0.2s; overflow: hidden; white-space: nowrap; }
        .nav-btn:hover, .nav-btn.active { color: var(--primary); background-color: rgba(0, 230, 118, 0.1); border-left: 3px solid var(--primary); }
        
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .tab-content { display: none; padding-bottom: 80px; } .tab-content.active { display: block; }
        
        .glass-panel { background: var(--bg-panel); padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 20px; }
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        input, select { background: #2a2a2a; border: 1px solid #444; color: white; padding: 12px; border-radius: 6px; flex: 1; font-size: 1rem; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: #000; } .btn-danger { background: var(--danger); color: white; }
        .btn-warn { background: var(--warning); color: #000; } .btn-blue { background: var(--secondary); color: white; }
        
        #mainTimer, #liveTimer { font-family: 'Roboto Mono', monospace; font-size: 4rem; text-align: center; text-shadow: 0 0 10px var(--primary); margin: 20px 0; line-height: 1; }
        
        .kart-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .kart-btn { background: #2a2a2a; border: 1px solid #444; border-radius: 10px; height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; user-select: none; }
        .kart-btn:active { transform: scale(0.98); }
        .kart-btn.flash { background: var(--primary) !important; color: #000 !important; }
        .k-num { font-size: 2.5rem; font-weight: bold; color: var(--warning); }
        
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
        th { text-align: left; background: #333; padding: 12px 10px; color: var(--primary); }
        td { padding: 10px; border-bottom: 1px solid #333; }
        
        /* Estilos da tabela Live/Resultados */
        .live-table th { background: var(--primary); color: black; font-weight: bold; }
        .live-table tr:nth-child(even) { background-color: rgba(255,255,255,0.05); }
        
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-panel); margin: 10% auto; padding: 25px; width: 400px; border-radius: 10px; border: 1px solid var(--primary); max-width: 90%; }
        
        #shareableResult { position: fixed; top: -9999px; left: -9999px; width: 1100px; background: #121212; padding: 40px; color: white; border: 5px solid var(--primary); visibility: hidden; }
        .legend { margin-top: 20px; font-size: 10px; color: #aaa; display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; border-top: 1px solid #333; padding-top: 10px; }

        @media (max-width: 768px) {
            body { flex-direction: column; height: 100vh; }
            .sidebar { width: 100%; height: auto; flex-direction: row; justify-content: space-around; padding: 10px 0; border-right: none; border-bottom: 1px solid #333; }
            .sidebar:hover { width: 100%; }
            .nav-btn { width: auto; padding: 8px 15px; border-left: none; border-bottom: 3px solid transparent; font-size: 0.9rem; flex-direction: column; gap: 5px; }
            .nav-btn.active { background: transparent; border-left: none; border-bottom: 3px solid var(--primary); color: var(--primary); }
            .nav-btn span { display: block; font-size: 0.75rem; }
            .main-content { padding: 15px; }
            .form-row { flex-direction: column; gap: 10px; }
            .form-row input, .form-row select, .form-row button { width: 100%; flex: none; }
            #mainTimer, #liveTimer { font-size: 15vw; margin: 10px 0; }
            .glass-panel button { width: 100%; margin-bottom: 10px; }
            .glass-panel button:last-child { margin-bottom: 0; }
            .kart-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .kart-btn { height: 100px; }
            .k-num { font-size: 2rem; }
            .modal-content { margin: 20% auto; width: 90%; }
        }
    </style>
</head>
<body>

<nav class="sidebar">
    <button class="nav-btn active" onclick="switchTab('race')"><span>‚è±Ô∏è Corrida</span></button>
    <button class="nav-btn" onclick="switchTab('live')"><span>üì∫ Ao Vivo</span></button>
    <button class="nav-btn" onclick="switchTab('circuits')"><span>üõ£Ô∏è Circuitos</span></button>
    <button class="nav-btn" onclick="switchTab('results')"><span>üèÜ Resultados</span></button>
</nav>

<div class="main-content">
    <div id="tab-race" class="tab-content active">
        <h2>Painel de Controle</h2>
        <div class="glass-panel">
            <div class="form-row">
                <select id="raceCircuitSelect"><option value="">Carregando...</option></select>
                <select id="raceMode"><option value="corrida">Modo: Corrida</option><option value="tomada">Modo: Tomada de Tempo</option></select>
                <input type="text" id="raceNameInput" placeholder="Nome da Bateria">
            </div>
            <div class="form-row">
                <input type="number" id="addKartNum" placeholder="N¬∫ Kart">
                <input type="text" id="addKartName" placeholder="Piloto">
                <button class="btn btn-blue" onclick="addDriverToGrid()">+ Adicionar</button>
            </div>
        </div>
        <div class="glass-panel" style="text-align: center;">
            <div id="mainTimer">00:00.000</div>
            <button id="btnStart" class="btn btn-primary" onclick="toggleStart()">INICIAR</button>
            <button id="btnPause" class="btn btn-warn" onclick="togglePause()" disabled>PAUSAR</button>
            <button id="btnFinish" class="btn btn-danger" onclick="finishRace()" disabled>FINALIZAR</button>
            <button id="btnNew" class="btn btn-blue" onclick="newRace()">NOVA CORRIDA</button>
        </div>
        <div id="kartGrid" class="kart-grid"></div>
        <div class="table-container">
            <table id="liveTable" style="margin-top:20px;">
                <thead><tr><th>Pos</th><th>Kart</th><th>Piloto</th><th>Voltas</th><th>Melhor</th><th>A√ß√£o</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="tab-live" class="tab-content">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid var(--primary); padding-bottom:10px; margin-bottom:20px;">
            <h2 style="margin:0; color:var(--primary)" id="liveRaceTitle">AGUARDANDO CORRIDA...</h2>
            <div style="text-align:right; font-size:0.9rem; color:#aaa" id="liveCircuitInfo"></div>
        </div>
        
        <div id="liveTimer" style="color:white;">00:00.000</div>
        
        <div class="table-container">
            <table class="live-table">
                <thead>
                    <tr><th>POS</th><th>PILOTO</th><th>MV</th><th>TMV</th><th>TT</th><th>DL</th><th>DA</th><th>TV</th><th>VM</th></tr>
                </thead>
                <tbody id="liveViewBody">
                    <tr><td colspan="9" style="text-align:center; padding:20px;">Aguardando dados da cronometragem...</td></tr>
                </tbody>
            </table>
        </div>
        <div class="legend">
            <span><b>POS:</b> Posi√ß√£o</span><span><b>MV:</b> Volta da Melhor</span><span><b>TMV:</b> Tempo Melhor Volta</span>
            <span><b>TT:</b> Tempo Total</span><span><b>DL:</b> Dif. Lider</span><span><b>DA:</b> Dif. Anterior</span>
            <span><b>TV:</b> Total Voltas</span><span><b>VM:</b> Velocidade M√©dia</span>
        </div>
    </div>

    <div id="tab-circuits" class="tab-content">
        <h2>Cadastro de Circuitos</h2>
        <div class="glass-panel">
            <input type="hidden" id="editCircuitId">
            <div class="form-row">
                <input type="text" id="circuitName" placeholder="Nome do Tra√ßado">
                <input type="number" id="circuitLength" placeholder="Extens√£o (m)">
                <button class="btn btn-primary" id="btnSaveCircuit" onclick="saveCircuit()">Salvar Circuito</button>
            </div>
        </div>
        <div class="table-container">
            <table id="circuitsTable"><thead><tr><th>Nome</th><th>Tamanho</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="tab-results" class="tab-content">
        <h2>Hist√≥rico de Baterias</h2>
        <div class="glass-panel"><label>Filtrar Dia:</label><input type="date" id="filterDate" onchange="loadHistory()" style="width:100%"></div>
        <div id="finalResultContainer"></div>
        <button class="btn btn-blue" onclick="generateImage()" style="width:100%; margin-top:10px;">üì∏ Baixar Resultado</button>
        <ul id="historyList" style="margin-top:20px; padding:0; list-style:none;"></ul>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>Editar Piloto</h3>
        <input type="hidden" id="editDriverId">
        <label style="font-size:0.8rem; color:#aaa">Posi√ß√£o For√ßada (Deixe vazio para autom√°tico)</label>
        <input type="number" id="editPos" placeholder="Ex: 1" style="width:100%; margin-bottom:10px; border: 1px solid var(--primary);">
        <input type="text" id="editName" placeholder="Nome" style="width:100%; margin-bottom:10px">
        <input type="number" id="editNum" placeholder="Kart" style="width:100%; margin-bottom:10px">
        <input type="number" id="editLaps" placeholder="Voltas" style="width:100%; margin-bottom:10px">
        <input type="text" id="editBest" placeholder="Melhor (MM:SS.mmm)" style="width:100%; margin-bottom:10px">
        <button class="btn btn-primary" onclick="saveDriverEdit()" style="width:100%; margin-bottom:10px;">Salvar</button>
        <button class="btn" onclick="document.getElementById('editModal').style.display='none'" style="width:100%;">Fechar</button>
    </div>
</div>

<div id="shareableResult">
    <h1 id="shareRaceName" style="text-align:center; color:var(--primary)">RESULTADO DA CORRIDA</h1>
    <h3 id="shareCircuitInfo" style="text-align:center; margin-bottom:20px;">Pista: - | Extens√£o: -</h3>
    <table style="width:100%; color:white; font-size:12px;">
        <thead><tr style="background:var(--primary); color:black"><th>POS</th><th>PILOTO</th><th>MV</th><th>TMV</th><th>TT</th><th>DL</th><th>DA</th><th>TV</th><th>VM</th></tr></thead>
        <tbody id="shareTableBody"></tbody>
    </table>
    <div class="legend">
        <span><b>POS:</b> Posi√ß√£o</span><span><b>MV:</b> Volta da Melhor</span><span><b>TMV:</b> Tempo Melhor Volta</span>
        <span><b>TT:</b> Tempo Total</span><span><b>DL:</b> Dif. Lider</span><span><b>DA:</b> Dif. Anterior</span>
        <span><b>TV:</b> Total Voltas</span><span><b>VM:</b> Velocidade M√©dia</span>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, orderBy, query, Timestamp, doc, updateDoc, where, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCXFxcygBteUYgUjuobsTSYVQRIJEgUFjA", authDomain: "cronometragem-kart.firebaseapp.com",
        projectId: "cronometragem-kart", storageBucket: "cronometragem-kart.firebasestorage.app",
        messagingSenderId: "494692374520", appId: "1:494692374520:web:d84624be4cc0b3d068280d"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let state = { drivers: [], raceStartTime: 0, elapsedTime: 0, isRunning: false, timerInterval: null, circuit: null };
    let liveListener = null;
    let liveTimerInterval = null;

    // --- SINCRONIZA√á√ÉO LIVE ---
    // Envia dados para o Firestore 'live/current'
    async function syncLive() {
        const raceName = document.getElementById('raceNameInput').value || "Bateria Ao Vivo";
        const mode = document.getElementById('raceMode').value;
        const payload = {
            raceName: raceName,
            drivers: state.drivers,
            startTime: state.raceStartTime, // Timestamp de quando come√ßou (ou delta)
            elapsedAtPause: state.elapsedTime, // Tempo acumulado se pausado
            isRunning: state.isRunning,
            circuit: state.circuit,
            mode: mode,
            timestamp: Date.now()
        };
        try {
            await setDoc(doc(db, "live", "current"), payload);
        } catch(e) { console.error("Erro sync:", e); }
    }

    // --- TECLADO E LAP ---
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
        if (e.key >= '0' && e.key <= '9') {
            const kartNumber = e.key;
            const driver = state.drivers.find(d => d.number === kartNumber);
            if (driver && state.isRunning) {
                registerLap(driver.id);
            }
        }
    });

    function registerLap(driverId) {
        const d = state.drivers.find(x => x.id === driverId);
        if (d) {
            d.laps.push(state.elapsedTime);
            const btn = document.querySelector(`[data-kart-id="${driverId}"]`);
            if (btn) {
                btn.classList.add('flash');
                setTimeout(() => btn.classList.remove('flash'), 200);
            }
            renderLiveTable();
            syncLive(); // Sincroniza ap√≥s registrar volta
        }
    }

    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        const t = document.getElementById(`tab-${tab}`); if(t) t.classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        if (window.event?.currentTarget?.tagName === 'BUTTON') window.event.currentTarget.classList.add('active');
        else {
            const map = { 'race':0, 'live':1, 'circuits':2, 'results':3 };
            const btns = document.querySelectorAll('.nav-btn');
            if(btns[map[tab]]) btns[map[tab]].classList.add('active');
        }

        // Se entrar na aba Live, ativa o listener
        if(tab === 'live') {
            if(!liveListener) initLiveView();
        } else {
            // Opcional: Desligar listener se sair da aba para economizar dados
            // if(liveListener) { liveListener(); liveListener = null; }
        }
    };

    window.newRace = () => {
        if(!confirm("Limpar dados para nova bateria?")) return;
        state.drivers = []; state.elapsedTime = 0; state.isRunning = false;
        clearInterval(state.timerInterval);
        document.getElementById('mainTimer').innerText = "00:00.000";
        document.getElementById('btnStart').style.display = 'inline-block';
        updateUI();
        syncLive(); // Limpa no servidor tamb√©m
    };

    window.addDriverToGrid = () => {
        const n = document.getElementById('addKartNum').value, p = document.getElementById('addKartName').value;
        if(n && p) { 
            state.drivers.push({ id: Date.now(), number: n, name: p, laps: [], manualBest: null, manualLaps: null, manualPosition: null }); 
            updateUI();
            syncLive();
        }
        document.getElementById('addKartNum').value = ""; document.getElementById('addKartName').value = "";
    };

    function updateUI() {
        const grid = document.getElementById('kartGrid'); grid.innerHTML = '';
        state.drivers.forEach((d) => {
            const b = document.createElement('div'); 
            b.className = 'kart-btn';
            b.setAttribute('data-kart-id', d.id);
            b.innerHTML = `<span class="k-num">#${d.number}</span><span>${d.name}</span>`;
            b.onclick = () => { if(state.isRunning) registerLap(d.id); };
            grid.appendChild(b);
        });
        renderLiveTable();
    }

    window.toggleStart = () => {
        const cVal = document.getElementById('raceCircuitSelect').value;
        if(!cVal) return alert("Selecione a pista");
        state.circuit = JSON.parse(cVal); state.isRunning = true;
        
        // Se estava pausado, continua. Se √© zero, inicia.
        if (state.elapsedTime === 0) state.raceStartTime = Date.now();
        else state.raceStartTime = Date.now() - state.elapsedTime;

        state.timerInterval = setInterval(() => { 
            state.elapsedTime = Date.now() - state.raceStartTime; 
            document.getElementById('mainTimer').innerText = formatTime(state.elapsedTime); 
        }, 33);
        
        document.getElementById('btnStart').style.display = 'none'; document.getElementById('btnPause').disabled = false; document.getElementById('btnFinish').disabled = false;
        syncLive();
    };

    window.togglePause = () => { 
        state.isRunning = false; 
        clearInterval(state.timerInterval); 
        document.getElementById('btnStart').style.display = 'inline-block'; 
        syncLive();
    };

    window.finishRace = async () => {
        if(!confirm("Salvar resultados?")) return;
        togglePause();
        const results = calculateFinalStats();
        await addDoc(collection(db, "races"), { raceName: document.getElementById('raceNameInput').value || "Bateria", circuit: state.circuit, date: Timestamp.now(), drivers: results });
        alert("Bateria salva!"); 
        loadHistory();
        syncLive();
    };

    function parseTimeStr(str) {
        if(!str) return Infinity;
        try {
            const [min, rest] = str.split(':');
            const [sec, ms] = rest.split('.');
            return (parseInt(min) * 60000) + (parseInt(sec) * 1000) + parseInt(ms || 0);
        } catch(e) { return Infinity; }
    }

    // Fun√ß√£o gen√©rica de c√°lculo usada tanto pelo Admin quanto pelo Viewer
    function calculateStatsFromData(drivers, mode, trackLen) {
        let stats = drivers.map(d => {
            let bestLapMs = Infinity, bestLapIdx = 0, prevTime = 0;
            // Garante que laps √© array
            const laps = d.laps || [];
            laps.forEach((curr, i) => { let lap = curr - prevTime; if(lap < bestLapMs) { bestLapMs = lap; bestLapIdx = i + 1; } prevTime = curr; });
            
            if(d.manualBest) bestLapMs = parseTimeStr(d.manualBest);

            const totalV = d.manualLaps !== null && d.manualLaps !== undefined ? d.manualLaps : laps.length;
            const totalMs = laps.length > 0 ? laps[laps.length-1] : 0;
            const avgSpd = (bestLapMs !== Infinity && trackLen > 0) ? (trackLen / (bestLapMs / 1000)) * 3.6 : 0;
            
            return { 
                id: d.id, name: d.name, number: d.number, 
                laps: totalV, bestLapIdx, bestLapMs, 
                bestLapDisplay: d.manualBest || formatTime(bestLapMs), 
                totalMs, avgSpd,
                manualPosition: d.manualPosition
            };
        });

        if(mode === "tomada") stats.sort((a,b) => a.bestLapMs - b.bestLapMs);
        else stats.sort((a,b) => b.laps - a.laps || a.totalMs - b.totalMs);

        // L√≥gica de posi√ß√£o for√ßada
        if (stats.some(s => s.manualPosition)) {
            const fixed = stats.filter(s => s.manualPosition).sort((a,b) => a.manualPosition - b.manualPosition);
            let floating = stats.filter(s => !s.manualPosition);
            let finalOrder = [];
            for(let i = 0; i < stats.length; i++) {
                const targetRank = i + 1;
                const forcedDriver = fixed.find(f => parseInt(f.manualPosition) === targetRank);
                if (forcedDriver) finalOrder.push(forcedDriver);
                else if (floating.length > 0) finalOrder.push(floating.shift());
            }
            finalOrder = [...finalOrder, ...floating, ...fixed.filter(f => !finalOrder.includes(f))];
            stats = finalOrder;
        }

        return stats.map((s, i) => ({ 
            ...s, 
            dl: i === 0 ? "-" : (s.laps < stats[0].laps ? `+${stats[0].laps - s.laps}v` : `+${formatTime(s.totalMs - stats[0].totalMs)}`), 
            da: i === 0 ? "-" : (s.laps < stats[i-1].laps ? `+${stats[i-1].laps - s.laps}v` : `+${formatTime(s.totalMs - stats[i-1].totalMs)}`) 
        }));
    }

    function calculateFinalStats() {
        const trackLen = parseFloat(state.circuit?.length || 0);
        const mode = document.getElementById('raceMode').value;
        return calculateStatsFromData(state.drivers, mode, trackLen);
    }

    function renderLiveTable() {
        const tb = document.querySelector('#liveTable tbody'); tb.innerHTML = '';
        calculateFinalStats().forEach((d, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${i+1}¬∫</td><td>#${d.number}</td><td>${d.name}</td><td>${d.laps}</td><td>${d.bestLapDisplay}</td><td><button class='btn-edit' data-id='${d.id}' style='padding:5px 10px'>‚úèÔ∏è</button></td>`;
            tr.querySelector('.btn-edit').onclick = () => openEditModal(d.id);
            tb.appendChild(tr);
        });
    }

    // --- L√ìGICA DO VIEWER (ABA AO VIVO) ---
    function initLiveView() {
        liveListener = onSnapshot(doc(db, "live", "current"), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                renderViewerData(data);
            } else {
                document.getElementById('liveRaceTitle').innerText = "SEM CORRIDA ATIVA";
            }
        });
    }

    function renderViewerData(data) {
        document.getElementById('liveRaceTitle').innerText = data.raceName || "AO VIVO";
        document.getElementById('liveCircuitInfo').innerText = data.circuit ? `${data.circuit.name} (${data.circuit.length}m)` : "";
        
        // Atualiza Timer Localmente no Viewer
        clearInterval(liveTimerInterval);
        if (data.isRunning) {
            // Se est√° rodando, calcula tempo baseado no timestamp de start do server
            liveTimerInterval = setInterval(() => {
                const currentElapsed = Date.now() - data.startTime;
                document.getElementById('liveTimer').innerText = formatTime(currentElapsed);
            }, 33);
        } else {
            // Se pausado, mostra o tempo onde parou
            document.getElementById('liveTimer').innerText = formatTime(data.elapsedAtPause || 0);
        }

        // Calcula stats com dados vindos do server
        const trackLen = parseFloat(data.circuit?.length || 0);
        const stats = calculateStatsFromData(data.drivers || [], data.mode || "corrida", trackLen);
        
        const tb = document.getElementById('liveViewBody'); tb.innerHTML = '';
        stats.forEach((d, i) => {
            tb.innerHTML += `<tr>
                <td>${i+1}¬∫</td>
                <td>#${d.number} ${d.name}</td>
                <td>${d.bestLapIdx}</td>
                <td>${d.bestLapDisplay}</td>
                <td>${formatTime(d.totalMs)}</td>
                <td>${d.dl}</td>
                <td>${d.da}</td>
                <td>${d.laps}</td>
                <td>${d.avgSpd.toFixed(1)}</td>
            </tr>`;
        });
    }

    window.openEditModal = (id) => {
        const d = state.drivers.find(x => x.id == id); if(!d) return;
        document.getElementById('editDriverId').value = d.id;
        document.getElementById('editName').value = d.name;
        document.getElementById('editNum').value = d.number;
        document.getElementById('editLaps').value = d.manualLaps !== null ? d.manualLaps : d.laps.length;
        document.getElementById('editBest').value = d.manualBest || "";
        document.getElementById('editPos').value = d.manualPosition || ""; 
        document.getElementById('editModal').style.display = 'block';
    };

    window.saveDriverEdit = () => {
        const id = document.getElementById('editDriverId').value;
        const d = state.drivers.find(x => x.id == id);
        if(d) {
            d.name = document.getElementById('editName').value;
            d.number = document.getElementById('editNum').value;
            d.manualLaps = parseInt(document.getElementById('editLaps').value);
            d.manualBest = document.getElementById('editBest').value;
            const posVal = document.getElementById('editPos').value;
            d.manualPosition = posVal ? parseInt(posVal) : null;
            document.getElementById('editModal').style.display = 'none';
            updateUI();
            syncLive();
        }
    };

    window.saveCircuit = async () => {
        const id = document.getElementById('editCircuitId').value, n = document.getElementById('circuitName').value, l = document.getElementById('circuitLength').value;
        if(id) await updateDoc(doc(db, "circuits", id), { name: n, length: l });
        else await addDoc(collection(db, "circuits"), { name: n, length: l, createdAt: Timestamp.now() });
        loadCircuits();
    };

    window.loadCircuits = async () => {
        const snap = await getDocs(collection(db, "circuits")), sel = document.getElementById('raceCircuitSelect'), tb = document.querySelector('#circuitsTable tbody');
        sel.innerHTML = '<option value="">Selecione...</option>'; tb.innerHTML = '';
        snap.forEach(d => {
            const data = d.data(); sel.innerHTML += `<option value='${JSON.stringify({id: d.id, ...data})}'>${data.name}</option>`;
            tb.innerHTML += `<tr><td>${data.name}</td><td>${data.length}m</td><td><button onclick='editCircuit("${d.id}", ${JSON.stringify(data)})'>‚úèÔ∏è</button></td></tr>`;
        });
    };

    window.editCircuit = (id, data) => { document.getElementById('editCircuitId').value = id; document.getElementById('circuitName').value = data.name; document.getElementById('circuitLength').value = data.length; };

    window.loadHistory = async () => {
        const dateFilter = document.getElementById('filterDate').value;
        let qry = query(collection(db, "races"), orderBy("date", "desc"));
        if(dateFilter) {
            const start = new Date(dateFilter + "T00:00:00"), end = new Date(dateFilter + "T23:59:59");
            qry = query(collection(db, "races"), where("date", ">=", start), where("date", "<=", end));
        }
        const snap = await getDocs(qry), list = document.getElementById('historyList'); list.innerHTML = '';
        snap.forEach(d => {
            const data = d.data(); const li = document.createElement('li');
            li.style.cssText = "padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;";
            li.innerHTML = `<span>${data.date.toDate().toLocaleTimeString()} - ${data.raceName}</span> <button class="btn btn-blue" style="padding:5px 10px; font-size:0.8rem" onclick='viewResult(${JSON.stringify(data)})'>Ver</button>`;
            list.appendChild(li);
        });
    };

    window.viewResult = (data) => {
        document.getElementById('shareRaceName').innerText = data.raceName;
        document.getElementById('shareCircuitInfo').innerText = `Pista: ${data.circuit.name} | Extens√£o: ${data.circuit.length}m`;
        const tb = document.getElementById('shareTableBody'); tb.innerHTML = '';
        data.drivers.forEach((d, i) => {
            tb.innerHTML += `<tr><td>${i+1}¬∫</td><td>#${d.number} ${d.name}</td><td>${d.bestLapIdx}</td><td>${d.bestLapDisplay}</td><td>${formatTime(d.totalMs)}</td><td>${d.dl}</td><td>${d.da}</td><td>${d.laps}</td><td>${d.avgSpd.toFixed(1)}</td></tr>`;
        });
        document.getElementById('finalResultContainer').innerHTML = `<h3 style='color:var(--primary); text-align:center;'>Exibindo: ${data.raceName}</h3>`;
    };

    window.generateImage = async () => {
        const el = document.getElementById('shareableResult'); el.style.visibility = "visible"; el.style.position = "fixed"; el.style.top = "0"; el.style.left = "0"; el.style.zIndex = "-100";
        const canvas = await html2canvas(el, { backgroundColor: "#121212", scale: 2 });
        const link = document.createElement('a'); link.download = 'resultado.png'; link.href = canvas.toDataURL(); link.click();
        el.style.visibility = "hidden"; el.style.top = "-9999px";
    };

    function formatTime(ms) {
        if(!ms || ms === Infinity || ms < 0) return "00:00.000";
        let m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000), ms_ = Math.floor(ms%1000);
        return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${ms_.toString().padStart(3,'0')}`;
    }

    window.onload = () => { loadCircuits(); loadHistory(); };
</script>
</body>
</html>
